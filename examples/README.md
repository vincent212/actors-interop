# actors-interop Examples

Four working examples demonstrating FFI communication between C++ and Rust actors.

## Examples Overview

| Example | Direction | Pattern | Description |
|---------|-----------|---------|-------------|
| [ping_pong](ping_pong/) | C++ -> Rust | Request/Response | C++ sends Ping, Rust replies with Pong |
| [rust_ping_cpp_pong](rust_ping_cpp_pong/) | Rust -> C++ | Request/Response | Rust sends Ping, C++ replies with Pong |
| [pubsub](pubsub/) | C++ -> Rust -> C++ | Pub/Sub | C++ subscribes, Rust publishes updates |
| [rust_subscribes_cpp_publisher](rust_subscribes_cpp_publisher/) | Rust -> C++ -> Rust | Pub/Sub | Rust subscribes, C++ publishes updates |

## Quick Start

Build and run all examples:

```bash
# Build Rust library first
cd ~/actors-interop/rust
cargo build --release

# Run each example
cd ~/actors-interop/examples/ping_pong && make && ./ping_pong
cd ~/actors-interop/examples/rust_ping_cpp_pong && make && ./rust_ping_cpp_pong
cd ~/actors-interop/examples/pubsub && make && ./pubsub
cd ~/actors-interop/examples/rust_subscribes_cpp_publisher && make && ./rust_subscribes_cpp_publisher
```

## Common Startup Sequence

All examples follow the same 7-step startup sequence:

1. **Create C++ Manager** - Create Manager and actors via `manage(actor)`
2. **Initialize C++ bridge** - `cpp_actor_init(&cpp_mgr);` enables Rust to find C++ actors
3. **Create Rust Manager** - `create_rust_manager();`
4. **Register Rust actors** - `register_rust_xxx_actor();` returns Manager pointer
5. **Initialize Rust bridge** - `rust_actor_init(rust_mgr);` enables C++ to find Rust actors
6. **Start C++ actors** - `cpp_mgr.init();` sends Start messages
7. **Start Rust actors** - `rust_manager_init();` sends Start messages

## Expected Output Summary

### 1. ping_pong (C++ -> Rust)

```
[C++ Ping] Sending Ping(1) to Rust...
[Rust Pong] Received Ping #1
[Rust Pong] Sending Pong #1 back to C++...
[C++ Ping] Received Pong(1) from Rust
... (repeats 5 times)
[C++ Ping] Done! Reached max count 5
```

### 2. rust_ping_cpp_pong (Rust -> C++)

```
[Rust Ping] Sending Ping #1
[C++ Pong] Received Ping #1
[C++ Pong] Using reply() to send Pong #1
[Rust Ping] Received Pong #1
... (repeats 3 times)
[Rust Ping] Ping-pong complete!
```

### 3. pubsub (C++ <- Rust)

```
[C++ Subscriber] Starting, subscribing to AAPL...
[Rust Publisher] Subscriber subscribing to 'AAPL'
[Rust Publisher] Sending update: AAPL @ $150.00
[C++ Subscriber] Update #1: AAPL @ $150 vol=100
... (3 updates total)
[C++ Subscriber] Received all updates, done!
```

### 4. rust_subscribes_cpp_publisher (Rust <- C++)

```
[Rust Subscriber] Subscribing to AAPL
[C++ Publisher] rust_price_monitor subscribing to 'AAPL'
[C++ Publisher] Sending AAPL @ $150.00
[Rust Subscriber] Update #1: AAPL @ 150.00 vol=...
... (multiple updates for AAPL and GOOG)
[C++ Publisher] Sent 3 update rounds, stopping.
```

## Architecture

All examples use the Manager-based FFI bridge:

```
C++ Side                                    Rust Side
--------                                    ---------

C++ Manager                                 Rust Manager
    |                                           |
    v                                           v
C++ Actor <-- cpp_actor_send() --------  Rust Actor
    |       (via CppActorIF)                    |
    |                                           |
    -------> rust_actor_send() --------> Rust Actor
             (via RustActorIF)
```

Key components:
- **C++ Manager** - Manages C++ actors via `manage()` and `get_actor_by_name()`
- **Rust Manager** - Manages Rust actors via `manage()` and `get_ref()`
- **RustActorIF** - C++ interface to send messages to Rust actors
- **CppActorIF** - Rust interface to send messages to C++ actors
- **RustSenderProxy** - Enables C++ `reply()` to route back to Rust
- **cpp_actor_init()/rust_actor_init()** - Initialize bridges with Manager pointers

## Message Flow

Messages are defined in `~/actors-interop/messages/interop_messages.h` and code is
auto-generated by `~/actors-interop/codegen/generate.py` for both C++ and Rust.

The generated code handles:
- Message struct conversions (`to_c_struct()`, `from_c_struct()`)
- Message type ID dispatch
- FFI bridge functions (`cpp_actor_send()`, `rust_actor_send()`)
